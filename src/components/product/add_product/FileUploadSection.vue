<script setup lang="ts">
import { useProductStore, type IProductImage, type IUploadImageResponse } from '@/stores/product/product';
import { useMutation } from '@tanstack/vue-query';
import { Button, FileUpload } from 'primevue'
import { toast } from 'vue3-toastify';

const props = defineProps<{
  showCertificate: boolean
  productImages: IProductImage[]
  certificateFile: string | undefined
}>()

const emit = defineEmits<{
  'update-product-images': [images: IProductImage[]]
  'update-certificate-file': [string | undefined]
}>()

const validateFileUpload = (file: File, maxSize: number = 2000000) => {
  if (file.size > maxSize) {
    toast.error('ขนาดไฟล์ใหญ่เกินไป (สูงสุด 2MB)')
    return false
  }

  if (!file.type.startsWith('image/')) {
    toast.error('กรุณาเลือกไฟล์รูปภาพเท่านั้น')
    return false
  }

  return true
}

const onProductImageSelect = (event: { files: File[] }) => {
  const file = event.files[0]
  if (file && validateFileUpload(file)) {
    uploadImage(file)
  }
}

const onCertificateSelect = (event: { files: File[] }) => {
  const file = event.files[0]
  if (file && validateFileUpload(file)) {
    uploadCertificate(file)
  }
}

const removeProductImage = (index: number) => {
  emit('update-product-images', props.productImages.filter((img, i) => i !== index))
}

const removeCertificate = () => {
  emit('update-certificate-file', undefined)
}

const productStore = useProductStore()
const { mutate: uploadImage, isPending: isUploadingImage } = useMutation({
  mutationFn: (file: File) => productStore.onUploadImage(file),
  onSuccess: (data: IUploadImageResponse) => {
    const filename = data.filename

    // Update productForm.images
    emit('update-product-images', [...props.productImages, {
      filename,
      type: 'image',
    }])

    toast.success('อัปโหลดรูปภาพสำเร็จ')
  },
  onError: (error: any) => {
    console.error('Upload error:', error)
    toast.error(error.response?.data?.message || 'อัปโหลดรูปภาพไม่สำเร็จ')
  },
})

const { mutate: uploadCertificate, isPending: isUploadingCertificate } = useMutation({
  mutationFn: (file: File) => productStore.onUploadImage(file),
  onSuccess: (data: IUploadImageResponse) => {
    const filename = data.filename

    emit('update-certificate-file', filename)
    toast.success('อัปโหลดใบรับรองสำเร็จ')
  },
  onError: (error: any) => {
    console.error('Upload error:', error)
    toast.error(error.response?.data?.message || 'อัปโหลดใบรับรองไม่สำเร็จ')
  },
})

const getImagePreview = (filename: string) => {
  return `${(import.meta as any).env.VITE_API_URL}/erp/download/product?name=${filename}`
}

</script>

<template>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <!-- Product Images -->
    <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
      <div class="flex items-center gap-2 mb-3">
        <i class="pi pi-image text-blue-600"></i>
        <h4 class="text-lg font-medium text-gray-800">รูปภาพสินค้า</h4>
      </div>

      <div v-if="productImages && productImages.length > 0" class="mb-4">
        <div class="grid grid-cols-2 gap-2">
          <div v-for="(image, index) in productImages" :key="index" class="relative">
            <img
              :src="getImagePreview(image.filename)"
              :alt="`Product image ${index + 1}`"
              class="w-full h-40 object-contain rounded-lg border border-gray-200"
            />
            <Button
              icon="pi pi-times"
              severity="danger"
              size="small"
              text
              rounded
              class="absolute top-1 right-1"
              @click="removeProductImage(index)"
            />
          </div>
        </div>
      </div>

      <FileUpload
        mode="basic"
        name="productImage"
        accept="image/*"
        :maxFileSize="2000000"
        @select="onProductImageSelect"
        :chooseLabel="isUploadingImage ? 'กำลังอัปโหลด...' : 'เพิ่มรูปภาพ'"
        :disabled="isUploadingImage"
        size="small"
      />
    </div>

    <!-- Certificate (for fish only) -->
    <div
      v-if="showCertificate"
      class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm"
    >
      <div class="flex items-center gap-2 mb-3">
        <i class="pi pi-file text-purple-600"></i>
        <h4 class="text-lg font-medium text-gray-800">ใบรับรอง</h4>
      </div>

      <div v-if="certificateFile" class="mb-4">
        <div class="relative">
          <img
            :src="getImagePreview(certificateFile)"
            alt="Certificate"
            class="w-full h-60 object-contain rounded-lg border border-gray-200"
          />
          <Button
            icon="pi pi-times"
            severity="danger"
            size="small"
            text
            rounded
            class="absolute top-1 right-1"
            @click="removeCertificate"
          />
        </div>
      </div>

      <FileUpload
        v-else
        mode="basic"
        name="certificate"
        accept="image/*"
        :maxFileSize="2000000"
        @select="onCertificateSelect"
        :chooseLabel="isUploadingCertificate ? 'กำลังอัปโหลด...' : 'เลือกใบรับรอง'"
        :disabled="isUploadingCertificate"
        size="small"
      />
    </div>
  </div>
</template>


